<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center">Energy Consumption Dashboard</h1>
        <div class="mb-3">
            <input type="file" id="fileInput" class="form-control d-inline-block w-auto" />
            <button class="btn btn-primary ms-2" onclick="uploadFile()">Upload</button>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <canvas id="usageChart"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="costChart"></canvas>
            </div>
        </div>
        
        <div class="mt-4 alert alert-warning" id="peakHour" style="display: none;"></div>
        <div class="mt-4 alert alert-danger" id="anomalies" style="display: none; max-height: 220px; overflow-y: auto;"></div>
        <div class="mt-4 alert alert-info" id="forecast" style="display: none;"></div>
        <div class="mt-4 alert alert-success" id="weekdayWeekend" style="display: none;"></div>
        <div class="mt-4 alert alert-primary" id="highCostDays" style="display: none; max-height: 220px; overflow-y: auto;"></div>
        <div class="mt-4">
            <canvas id="hourlyUsageChart"></canvas>
        </div>
    </div>

    <script>
        function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) return alert("Please select a file to upload.");
            
            const formData = new FormData();
            formData.append("file", file);
            
            fetch("http://localhost:8000/upload", { method: "POST", body: formData })
                .then(() => loadData())
                .catch(err => alert("File upload failed: " + err));
        }

        async function loadData() {
            const usageRes = await fetch("http://localhost:8000/total_usage?period=day");
            const costRes = await fetch("http://localhost:8000/cost_trends?period=day");
            const peakRes = await fetch("http://localhost:8000/peak_hours");
            const anomalyRes = await fetch("http://localhost:8000/anomalies");
            const forecastRes = await fetch("http://localhost:8000/forecast_usage?days=7");
            const weekdayWeekendRes = await fetch("http://localhost:8000/weekday_vs_weekend");
            const highCostRes = await fetch("http://localhost:8000/high_cost_days");
            const hourlyUsageRes = await fetch("http://localhost:8000/hourly_usage_trend");
            
            const usageData = await usageRes.json();
            const costData = await costRes.json();
            const peakHour = await peakRes.json();
            const anomalies = await anomalyRes.json();
            const forecast = await forecastRes.json();
            const weekdayWeekend = await weekdayWeekendRes.json();
            const highCostDays = await highCostRes.json();
            const hourlyUsageData = await hourlyUsageRes.json();
            
            updateChart("usageChart", "Energy Usage (kWh)", usageData);
            updateChart("costChart", "Cost Trends ($)", costData);
            
            document.getElementById("peakHour").style.display = "block";
            document.getElementById("peakHour").innerHTML = `<strong>Peak Hour:</strong> ${peakHour.peak_hour}:00 - Usage: ${peakHour.usage} kWh`;
            
            if (anomalies.length > 0) {
                document.getElementById("anomalies").style.display = "block";
                document.getElementById("anomalies").innerHTML = `<strong>Anomalies Detected:</strong><ul>${anomalies.slice(0, 5).map(a => `<li>${a.DATETIME}: ${a["USAGE (kWh)"]} kWh</li>`).join('')}</ul>`;
            }
            
            document.getElementById("forecast").style.display = "block";
            document.getElementById("forecast").innerHTML = `<strong>Forecasted Usage (Next 7 Days):</strong><ul>${Object.entries(forecast).map(([date, usage]) => `<li>${date}: ${usage} kWh</li>`).join('')}</ul>`;
            
            document.getElementById("weekdayWeekend").style.display = "block";
            document.getElementById("weekdayWeekend").innerHTML = `<strong>Weekday vs Weekend Usage:</strong> Weekday: ${weekdayWeekend.weekday_usage} kWh, Weekend: ${weekdayWeekend.weekend_usage} kWh`;
            
            document.getElementById("highCostDays").style.display = "block";
            document.getElementById("highCostDays").innerHTML = `<strong>High Cost Days:</strong><ul>${Object.entries(highCostDays).slice(0, 5).map(([date, cost]) => `<li>${date}: $${cost}</li>`).join('')}</ul>`;
            
            updateChart("hourlyUsageChart", "Hourly Usage Trend", hourlyUsageData);
        }

        function updateChart(canvasId, label, data) {
            const ctx = document.getElementById(canvasId).getContext("2d");
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: label,
                        data: Object.values(data),
                        borderColor: "#007bff",
                        fill: false
                    }]
                }
            });
        }
    </script>
</body>
</html>